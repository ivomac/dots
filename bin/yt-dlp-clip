#!/usr/bin/env bash

ICON=/usr/share/icons/Papirus/128x128/apps/youtube-dl.svg

DL_TEMP=$(mktemp -d)
trap 'rm -rf "$DL_TEMP"' EXIT

notify() {
  notify-send --icon "$ICON" "YT-DLP: $1" "$2"
}

url="$(wl-paste)"

if ! echo "$url" | grep -q "^https\?://"; then
  notify "Input not a URL" "$url"
  exit 1
fi

base_opts=(--remote-components ejs:github --paths "temp:$HOME/yt-dlp-parts" --output "%(title)s.%(ext)s")
if [[ "$1" == "song" ]]; then
  typ="Song"
  opts=(--paths "home:$MEDIA/Music" --extract-audio --audio-quality 2 --audio-format mp3 --format 'ba[acodec^=mp3]/ba/b')
else
  opts=(--paths "home:$HOME/Downloads" --write-subs --embed-subs --concurrent-fragments 4 --remux-video "mkv>mp4/webm>mp4" --merge-output-format mp4/mkv/webm --format "best[height=720]/bestvideo[height=720]+bestaudio/best[height=1080]/bestvideo[height=1080]+bestaudio/best" --format-sort "res:720,fps:60,ext:mp4:m4a")
  typ="Clip"
fi

notify "Downloading $typ" "$url"

if ! yt-dlp "${base_opts[@]}" "${opts[@]}" "$url"; then
  notify "Download Failed" "$url"
else
  notify "Download Finished" "$url"
fi
