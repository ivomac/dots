#!/usr/bin/env zsh

ICON=/usr/share/icons/Papirus/128x128/apps/youtube-dl.svg

DL_HOME="/tmp/yt-dlp"

rm -rf "$DL_HOME"
mkdir -p "$DL_HOME"

function notify() {
  notify-send --icon "$ICON" "YT-DLP: $1" "$2"
}

url="$(wl-paste)"

if ! echo "$url" | grep -q "^https\?://"; then
  notify "Input not a URL" "$url"
  exit 1
fi

opts=""
dest="$HOME/Downloads/"
typ="Clip"
if [[ "$1" == "song" ]]; then
  typ="Song"
  opts="--extract-audio --audio-quality 2"
  dest="$MEDIA/Music/"
fi

notify "Downloading $typ" "$url"
yt-dlp --paths "temp:/tmp" --paths "home:$DL_HOME" --output "%(title)s" ${=opts} "$url" &>/dev/null

if [[ $? -ne 0 ]]; then
  notify "Download Failed" "$url"
else
  notify "Download Finished" "$url"
  tmp_path="$(fd --type file . "$DL_HOME" | head -n 1)"
  base=$(basename "$tmp_path")
  short_base=$(echo "$base" \
    | sed -E -e 's/\[[^]]*\]//g' \
      -e 's/\([^)]*\)//g' \
      -e 's/\{[^}]*\}//g' \
    | sed -E -e 's/\s\s+/ /g' \
    | sed -E -e 's/\s\././g'
  )
  mv "$tmp_path" "$dest/$short_base"
  if [[ $? -ne 0 ]]; then
    notify "Move Failed" "Failed to move the downloaded file to $dest"
  else
    notify "Move Success" "$short_base moved to $dest"
  fi
fi
