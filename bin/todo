#!/usr/bin/env python

import subprocess as sp
from os import environ
from pathlib import Path
from sys import argv

import filelock
import pyperclip as clip


class Todo:
    def __init__(self):
        clip.set_clipboard("wl-clipboard")

        self.gist = environ["GIST_KEY"]
        self.menu = [
            "fzf",
            "--bind=enter:accept-or-print-query",
            "--exact",
            "--input-label",
            " ï‚® TODO ",
        ]
        self.editor = environ["EDITOR"].split()

        self.filepath = Path("/tmp/todo")
        self.lock = filelock.FileLock("/tmp/todo.lock", timeout=0.1)

        return

    def main(self):
        current_todo = sp.check_output(["gist", "-r", self.gist, "todo"], text=True).rstrip("\n")

        with self.lock:
            with self.filepath.open("w+") as file:
                if len(argv) > 1 and argv[1] in "edit":
                    self.edit(file, current_todo)
                else:
                    self.menuview(file, current_todo)

            cmd = ["nohup", "gist", "-u", self.gist, str(self.filepath)]
            sp.Popen(cmd, stdin=sp.DEVNULL, stdout=sp.DEVNULL, stderr=sp.DEVNULL)
        return

    def edit(self, file, todolist):
        file.write(todolist)
        file.flush()
        sp.call([*self.editor, file.name])
        return

    def menuview(self, file, todolist):
        while 1:
            try:
                out = sp.check_output(
                    self.menu,
                    input=todolist,
                    text=True,
                ).rstrip("\n")
            except sp.CalledProcessError:
                break

            lines = todolist.split("\n")
            if out in lines:
                lines.remove(out)
                clip.copy(out)
            else:
                lines.insert(0, out)

            todolist = "\n".join(lines)
        file.write(todolist)
        file.flush()
        return


if __name__ == "__main__":
    Todo().main()
